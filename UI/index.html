<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>飛遊 App Prototype</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* --- CSS 開始 --- */
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --header-height: 50px;
            --sidebar-width: 320px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        a { text-decoration: none; color: inherit; }

        body {
            background-color: #f0f0f0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 0;
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Header */
        header {
            background-color: #333;
            color: white;
            height: calc(var(--header-height) + var(--safe-top));
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--safe-top) 15px 0 15px;
            /* Header 層級很高 (2000) */
            z-index: 2000;
            position: sticky;
            top: 0;
            flex-shrink: 0;
            width: 100%;
        }

        .header-title { font-size: 18px; font-weight: 500; }
        
        .menu-btn, .action-btn { 
            cursor: pointer; 
            font-size: 20px; 
            padding: 10px; 
            display: flex !important;
            align-items: center;
            justify-content: center;
        }
        .menu-btn:active, .action-btn:active { opacity: 0.6; transform: scale(0.96); }

        /* Sidebar */
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2001;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }

        .sidebar {
            position: fixed; top: 0; left: 0;
            width: 85%; max-width: var(--sidebar-width); height: 100%;
            background: white; z-index: 2002;
            transform: translateX(-100%); transition: transform 0.3s ease-in-out;
            display: flex; flex-direction: column;
            padding-top: var(--safe-top);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar.active { transform: translateX(0); }

        .sidebar-header { 
            padding: 20px; 
            display: flex; justify-content: flex-end; align-items: center; 
        }
        
        .sidebar-content { flex: 1; overflow-y: auto; padding: 0 20px; }
        
        .new-trip-btn { 
            display: flex; align-items: center; margin-bottom: 20px; cursor: pointer; 
            color: #333; 
        }
        .new-trip-btn i { margin-right: 10px; }
        
        .sidebar-divider { border: 0; border-top: 1px solid #eee; margin-bottom: 15px; }
        
        .trip-item { 
            display: flex; justify-content: flex-start; align-items: center; 
            padding: 15px 0; cursor: pointer; 
        }
        .trip-info { display: flex; align-items: center; flex: 1; }
        .trip-text { display: flex; flex-direction: column; margin-left: 10px; }
        .trip-text h4 { font-size: 16px; margin-bottom: 4px; font-weight: normal; }
        .trip-text span { font-size: 12px; color: #888; }
        
        .bookmark-icon { padding: 5px; color: #333; transition: transform 0.2s; }
        .bookmark-icon:active { transform: scale(1.2); }

        /* Map */
        .map-container {
            flex: 1; position: relative; width: 100%;
            background-color: #e5e3df;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/b/bd/OpenStreetMap_Logo_2011.svg/1024px-OpenStreetMap_Logo_2011.svg.png');
            background-size: cover; background-position: center;
            overflow: hidden;
            z-index: 0;
        }
        .map-pin { position: absolute; color: #ff4d4f; font-size: 30px; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .pin-1 { top: 40%; left: 30%; }
        .pin-2 { top: 50%; left: 60%; }

        /* --- FAB (懸浮按鈕群組) --- */
        .fab-group {
            position: absolute; 
            right: 15px; 
            bottom: 220px; /* 初始收合時的位置 */
            display: flex; 
            flex-direction: column;
            gap: 10px;
            transition: all 0.3s ease;
            /* 層級設定：要比 Map(0) 和 Sheet(500) 高，但比 Header(2000) 低 */
            z-index: 1500; 
        }

        .fab {
            width: 45px; height: 45px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 20px; color: #333; cursor: pointer;
        }

        /* FAB 水平狀態 (當白框展開時) */
        .fab-group.horizontal {
            bottom: auto; /* 取消底部定位 */
            
            /* 【修正重點】定位在 Header 下方，確保不被 Header 蓋住 */
            /* Header高度 + 安全區域 + 10px間距 */
            top: calc(var(--header-height) + var(--safe-top) + 50px); 
            
            right: 15px;
            flex-direction: row; /* 變橫向 */
        }

        /* Bottom Sheet */
        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease-in-out;
            height: 200px;
            display: flex; flex-direction: column;
            z-index: 500;
        }
        .bottom-sheet.expanded { height: 75%; }

        .sheet-handle-bar { width: 100%; padding: 15px 0 5px 0; display: flex; justify-content: center; cursor: pointer; touch-action: none; }
        .sheet-handle { width: 40px; height: 5px; background: #ddd; border-radius: 5px; }
        
        .sheet-header { 
            padding: 0 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            flex-shrink: 0; cursor: pointer; touch-action: none; height: 50px; 
        }

        .sheet-content {
            flex: 1; overflow-y: auto; padding: 10px 20px;
            -webkit-overflow-scrolling: touch;
            padding-bottom: calc(20px + var(--safe-bottom)); 
        }

        /* Timeline UI */
        .timeline-item { 
            display: flex; margin-bottom: 20px; position: relative; transition: background 0.2s; 
            background: #fff; /* 確保拖拽時有背景色 */
            border-radius: 8px; /* 拖拽時好看一點 */
        }
        .timeline-left { display: flex; flex-direction: column; align-items: center; margin-right: 15px; width: 60px; }
        .location-img { width: 60px; height: 60px; background-color: #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; pointer-events: none; /* 防止拖拽圖片 */ }
        .timeline-connector { flex: 1; width: 1px; border-left: 2px dotted #ccc; margin: 5px 0; min-height: 30px; }
        .timeline-transit { display: flex; align-items: center; justify-content: center; margin: 10px 0; color: #999; font-size: 12px; }
        .timeline-transit i { margin-right: 5px; }
        .timeline-right { flex: 1; padding-top: 5px; }
        .timeline-title { font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; }
        .timeline-desc { font-size: 12px; color: #999; margin-top: 5px; line-height: 1.4; }
        .time-badge { font-size: 10px; background: #f0f0f0; padding: 2px 6px; border-radius: 10px; color: #666; font-weight: normal; }
        .day-header { font-size: 14px; font-weight: bold; margin: 15px 0; color: #333; position: sticky; top: 0; background: white; z-index: 10; padding: 5px 0; }

        /* 拖拽時的樣式 (SortableJS 預設 class) */
        .sortable-ghost { opacity: 0.4; background: #f0f0f0; }
        .sortable-drag { opacity: 1; transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        /**/
        .sortable-chosen {
            background-color: #e0e0e0 !important; /* 淺灰色 */
            transform: scale(1.02); /* 稍微放大 */
        }

        /* 編輯模式 */
        .delete-btn {
            display: none;
            position: absolute; right: -10px; top: 0;
            background: #ff4d4f; color: white;
            width: 25px; height: 25px; border-radius: 50%;
            text-align: center; line-height: 25px;
            cursor: pointer; font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10;
        }
        .add-item-btn {
            display: none;
            width: 100%; padding: 12px; margin-top: 10px;
            background-color: #f0f0f0; color: #333;
            border: 2px dashed #ccc; border-radius: 10px;
            text-align: center; cursor: pointer; font-weight: bold;
        }
        /* 編輯模式下顯示刪除與新增按鈕 */
        .sheet-content.editing .delete-btn { display: block; animation: fadeIn 0.3s; }
        .sheet-content.editing .add-item-btn { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        /* --- CSS 結束 --- */
    </style>
</head>
<body>

    <header>
        <div class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
        <div class="header-title">飛遊</div>
        <div class="action-btn" onclick="downloadPDF()"><i class="fas fa-download"></i></div>
    </header>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="action-btn close-sidebar-btn" onclick="toggleSidebar()"><i class="fas fa-chevron-left"></i></div>
        </div>
        <div class="sidebar-content">
            <a href="new-trip.html" class="new-trip-btn">
                <i class="far fa-square-plus"></i>
                <span>開啟新行程</span>
            </a>
            <hr class="sidebar-divider">
            <div class="trip-item">
                <div class="trip-info">
                    <i class="fas fa-bookmark bookmark-icon" onclick="toggleBookmark(this)"></i>
                    <div class="trip-text">
                        <h4>東京三日遊</h4>
                        <span>2025/01/10</span>
                    </div>
                </div>
            </div>
            <div class="trip-item">
                <div class="trip-info">
                    <i class="far fa-bookmark bookmark-icon" onclick="toggleBookmark(this)"></i>
                    <div class="trip-text">
                        <h4>大阪當天來回</h4>
                        <span>2024/12/20</span>
                    </div>
                </div>
            </div>
            <div class="trip-item">
                <div class="trip-info">
                    <i class="fas fa-bookmark bookmark-icon" onclick="toggleBookmark(this)"></i>
                    <div class="trip-text">
                        <h4>北海道滑雪</h4>
                        <span>2024/02/01</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="map-container" id="mapContainer">
        <div class="map-pin pin-1"><i class="fas fa-map-marker-alt"></i></div>
        <div class="map-pin pin-2"><i class="fas fa-map-marker-alt"></i></div>

        <div class="fab-group" id="fabGroup">
            <a href="chat.html" class="fab"><i class="fas fa-robot"></i></a>
            <div class="fab" onclick="toggleEditMode()" id="editFab"><i class="fas fa-pen"></i></div>
        </div>

        <div class="bottom-sheet" id="bottomSheet">
            <div class="sheet-handle-bar" id="dragHandle">
                <div class="sheet-handle"></div>
            </div>

            <div class="sheet-header" id="dragHeader">
                <h3>第一日行程</h3>
            </div>

            <div class="sheet-content" id="sheetContent">
                
                <div id="timelineList">
                    <div class="timeline-item">
                        <div class="delete-btn" onclick="deleteItem(this)"><i class="fas fa-trash"></i></div>
                        <div class="timeline-left">
                            <div class="location-img"><i class="far fa-image"></i></div>
                            <div class="timeline-connector"></div>
                        </div>
                        <div class="timeline-right">
                            <div class="timeline-title">
                                大阪城
                                <span class="time-badge">20分鐘</span>
                            </div>
                            <div class="timeline-desc">參觀歷史名城，拍攝天守閣美景。</div>
                        </div>
                    </div>

                    <div class="timeline-item">
                        <div class="delete-btn" onclick="deleteItem(this)"><i class="fas fa-trash"></i></div>
                        <div class="timeline-left">
                            <div class="location-img"><i class="far fa-image"></i></div>
                        </div>
                        <div class="timeline-right">
                            <div class="timeline-title">
                                道頓堀
                                <span class="time-badge">1小時</span>
                            </div>
                            <div class="timeline-desc">享受大阪美食，固力果跑跑人打卡。</div>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="delete-btn" onclick="deleteItem(this)"><i class="fas fa-trash"></i></div>
                        <div class="timeline-left">
                            <div class="location-img"><i class="far fa-image"></i></div>
                            <div class="timeline-connector"></div>
                        </div>
                        <div class="timeline-right">
                            <div class="timeline-title">
                                心齋橋商店街
                                <span class="time-badge">2小時</span>
                            </div>
                            <div class="timeline-desc">藥妝店購物，伴手禮採買。</div>
                        </div>
                    </div>
                </div>
                <div class="add-item-btn" onclick="addItem()">
                    <i class="fas fa-plus"></i> 新增行程
                </div>

                <div style="height: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        const sheet = document.getElementById('bottomSheet');
        const fabGroup = document.getElementById('fabGroup');
        const mapContainer = document.getElementById('mapContainer');
        const dragHandle = document.getElementById('dragHandle');
        const dragHeader = document.getElementById('dragHeader');
        
        let isEditMode = false;
        const sheetContent = document.getElementById('sheetContent');
        const editFab = document.getElementById('editFab').querySelector('i');

        // --- SortableJS 設定 (拖拽功能) ---
        // 取得列表容器
        const timelineList = document.getElementById('timelineList');
        
        // 初始化 Sortable
        let sortable = new Sortable(timelineList, {
            animation: 150,       // 動畫時間
            disabled: true,       // 預設關閉 (只有編輯模式開啟)
            delay: 400,           // 手機長按 400ms 後才能拖拽
            delayOnTouchOnly: true, // 只在觸控裝置啟用長按
            ghostClass: 'sortable-ghost', // 拖拽時留下的影子樣式
            dragClass: 'sortable-drag',   // 正在被拖拽的項目樣式
        });

        // 編輯模式切換
        function toggleEditMode() {
            event.stopPropagation();
            isEditMode = !isEditMode;

            if (isEditMode) {
                // 進入編輯模式
                sheetContent.classList.add('editing');
                editFab.classList.remove('fa-pen');
                editFab.classList.add('fa-check');
                openSheet();
                
                // 啟用拖拽功能
                sortable.option("disabled", false);
            } else {
                // 退出編輯模式
                sheetContent.classList.remove('editing');
                editFab.classList.remove('fa-check');
                editFab.classList.add('fa-pen');
                
                // 停用拖拽功能
                sortable.option("disabled", true);
            }
        }

        function deleteItem(btnElement) {
            const item = btnElement.closest('.timeline-item');
            if (item) {
                item.style.opacity = '0';
                item.style.transform = 'translateX(-20px)';
                setTimeout(() => { item.remove(); }, 300);
            }
        }

        function addItem() {
            const newItemHTML = `
                <div class="delete-btn" onclick="deleteItem(this)"><i class="fas fa-trash"></i></div>
                <div class="timeline-left">
                    <div class="location-img"><i class="far fa-image"></i></div>
                </div>
                <div class="timeline-right">
                    <div class="timeline-title">
                        新景點
                        <span class="time-badge">1小時</span>
                    </div>
                    <div class="timeline-desc">點擊以編輯詳細資訊...</div>
                </div>
            `;
            const div = document.createElement('div');
            div.className = 'timeline-item';
            div.innerHTML = newItemHTML;
            
            // 加入到列表容器中 (timelineList)
            timelineList.appendChild(div);
            
            // 滾動到底部
            const addButton = document.querySelector('.add-item-btn');
            addButton.scrollIntoView({ behavior: 'smooth' });
        }

        function toggleSidebar() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function toggleBookmark(iconElement) {
            event.stopPropagation();
            if (iconElement.classList.contains('fas')) {
                iconElement.classList.remove('fas');
                iconElement.classList.add('far');
            } else {
                iconElement.classList.remove('far');
                iconElement.classList.add('fas');
            }
        }

        function openSheet() {
            sheet.classList.add('expanded');
            fabGroup.classList.add('horizontal');
        }

        function closeSheet() {
            if (isEditMode) toggleEditMode(); 
            sheet.classList.remove('expanded');
            fabGroup.classList.remove('horizontal');
        }

        function toggleBottomSheet() {
            if (sheet.classList.contains('expanded')) {
                closeSheet();
            } else {
                openSheet();
            }
        }
        
        dragHandle.addEventListener('click', toggleBottomSheet);
        dragHeader.addEventListener('click', toggleBottomSheet);

        let startY = 0;
        const threshold = 50;
        function handleTouchStart(e) { startY = e.touches[0].clientY; }
        function handleTouchEnd(e) {
            let endY = e.changedTouches[0].clientY;
            let distance = startY - endY;
            if (distance > threshold) openSheet();
            else if (distance < -threshold) closeSheet();
        }

        dragHandle.addEventListener('touchstart', handleTouchStart, {passive: true});
        dragHandle.addEventListener('touchend', handleTouchEnd);
        dragHeader.addEventListener('touchstart', handleTouchStart, {passive: true});
        dragHeader.addEventListener('touchend', handleTouchEnd);

        mapContainer.addEventListener('click', function(e) {
            if (!sheet.contains(e.target) && !fabGroup.contains(e.target) && sheet.classList.contains('expanded')) {
                closeSheet();
            }
        });

        function downloadPDF() {
            alert('正在下載行程 PDF 檔案...');
        }
    </script>
</body>
</html>